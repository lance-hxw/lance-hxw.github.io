[[MQ消息处理的 at least once#生产端持久化]]
[[MQ消息处理的 at least once#消费者可靠性]]

# broker可靠性

## 持久化

### queue持久化
队列创建时, durable设置true, 队列的元数据就被保存在磁盘, 重启后, 队列会重建, 不过其中msg会丢

### 消息持久化

发消息的时候设置delivery_mode = 2  持久化,或者设置persistent = True

### exchange持久化
exchange的配置信息也要持久化

## 持久化具体实现

元信息: 使用内部数据库存储
消息:
- 存在本地消息存储文件中 msg_store
- 先写内存再异步写磁盘, 使用日志文件保证完整, 并强制刷盘
	- 同样进行追加写日志进行持久化, 周期性垃圾回收, 回收时, 将还没消费的msg重写到新文件中, 删除整个老文件
	- fsync发生在: 
		- 队列索引写入达阈值, 或者经过足够长时间
		- 定时, 文件切换
		- 事务提交
- 性能提升:
	- 批量写
	- 消息索引和内容分离
		- 持久化的队列有自己的索引信息, 可以快速访问队列中元素
			- 注意不是msg的持久化
	- 内存映射文件

# 底层的生产逻辑
当生产一条persistent的消息时, 流程为:
- mq接受msg
- msg被追加写入msg_store的末尾, os层面是写入page cache
- 写入队列索引中, 同样是写入pagecache
- fsync: 当队列索引更新达到阈值, 或者定时时间到
	- 此时将page cache中的数据都刷盘
