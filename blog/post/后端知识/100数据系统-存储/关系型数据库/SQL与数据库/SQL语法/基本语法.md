
- SQL可以单行或者多行, 最后需要;结尾
- SQL可以用空格 或者 缩进
- MySQL的SQL不区分大小写
	- 表名看情况
	- 列名不区分
- 注释: 
	- 单行 -- 注释内容 或者# 注释内容(这是mysql特有)
	- 多行 /\*注释内容\*/

## 分类
- DDL ： 数据定义语言, 定义数据库, 表, 字段
- DML： 数据操作语言, 增删改
- DQL： 数据查询语言, 查
- DCL： 数据控制语言, 用户/权限
## 数据定义
### 数据库操作
查所有数据库 show databases;
查当前是哪个数据库 select database();
创建数据库:
```sql
create database [IF NOT EXISTS] db_name [DEFAULT CHARSET 字符集] [COLLATE 排序规则]
```
- 加了ifnotexists不会报错
- 字符集不建议utf-8, 最好用utf-8mb4
删除数据库
```sql
drop database [IF EXISTS] db_name
```
使用
```sql
use db_name;
```
### 表操作
当前数据库所有表 show tables;
查看表结构 desc table_name;
查指定表的建表语句 show create table table_name
创建表:
```sql
create table table_name (
	name 类型 [COMMENT 字段注释],
)[comment 表注释];
# 注意最后一个字段没有逗号
```

加字段：ALTER table table_name ADD 字段名 类型 注释 约束
如 ：`ALTER TABLE emp ADD nickname varchar(20) COMMENT '昵称';`
修改数据类型： ALTER table 表名 MODIFY 字段名 新类型
修改字段名和数据类型：
ALTER TABLE 表名 CHANGE 旧字段名 新字段名 类型 注释 约束
删除字段 ALTER TABLE 表名 DROP 字段名；
修改表明 ALTER TABLE 表名 RENAME TO 新表名
删表： DROP TABLE if exists 表名；
删表再重创建： TRUNCATE TABLE 表名

## 数据操作 CUD
### insert
```sql
# 指定字段
insert into 表名 （，，，） values (,,,);
# 全部字段
insert into 表名 values （，，，）;
# 批量插入
insert into 表名 (,,,) values (,,,),(,,,),(,,,);
insert into 表名 vlaues (,,,),(,,,);
```
注意， 字符串和日期类型应该在引号中
### update delete
```sql
# update
update 表名 set 字段=值,... [where ];
# delete
delete from 表名 [where ];
```
##  数据查询
语法：
```sql
select xxxx,xxx,xxx
from 表名
where 条件
group by 分组字段列表
having 分组后的条件列表
order by 排序字段列表
limit 分页参数；


# 别名
select col_name as a

# 去重
select distinct col_name, ... from ..
```
可以认为执行顺序为:
from, where, group, select(定义字段名) ,having, order limit
### where表达式
- 注意=比较可以比较两个元组
除了数值和基本逻辑比较外， 还有
between 。。。 and 。。。 在某个范围内
in （。。。）， 是值中的一个
like 模糊匹配
- %表示任意长度字符串, 如%abc%，可以匹配aabcxxx
- \_表示任意单个字符
- 区分大小写
- 注意转义
is null
还有and，or，not这些逻辑操作

### 聚合查询
常用函数有：
- count
- max
- min
- avg
- sum
使用：
select 聚合函数（字段列表） 聚合字段名 from .....
### 分组查询
即使用group by和having字段
having是在分组后对结果过滤, where是提前过滤
having可以使用聚合字段作为条件,where不行(因为聚合是where后执行的)
使用分组字段后, 一般都是返回分组字段和聚合字段, 不然无意义
**分组后聚合函数是在组内执行**
如: 
```sql
-- 年龄小于45，并根据工作地址分组，获取员工数量大于等于3的工作地址  
select workaddress, count(*) address_count from employee where age < 45 group by workaddress having address_count >= 3;
```
### 排序
order by 字段 排序方式, 字段 排序方式
可以指定多个, 依次执行(iff前一个字段相同,才会执行下一个)
排序方式有:
- ASC: 默认
- DESC: 降序
### 分页查询
limit 起始索引, 查询记录数

## 控制语言

### 用户控制
```sql
# 查询所有用户
select * from user;

# 创建
create user '用户名'@'主机名' identified by '密码';

# 修改用户密码
alter user '用户名'@'主机名' identified with 'old' by'new'

# 删除
drop user '用户名'@'主机名'
```
主机名可以用%通配
### 权限控制
权限有:
- ALL, ALL privileges 所有
- SELECT
- INSERT
- UPDATE修改数据
- DELETE
- ALTER修改表
- DROP(删除数据库和表)
- CREATE(创建数据库和表)

```sql
# 查询权限
show grants for 'user_name'@'host_name';

# 给权限
grant 权限列表 on 数据库名.表名 to 'user_name'@'host_name';

# 取消权限
revoke 权限列表 on 数据库名.表名 from "@";
```
数据库名和表名可以用\*通配, 表示所有表上的权限
## 函数
- 字符串函数: 拼接,小写大写,左右填充到指定长度,子串,替代
- 数值函数: 取整,取模,随机数(0-1)
- 日期函数: 当前日期,当前时间,时间和日期,指定date的年月日间隔天数,间隔秒数
	- interval表示时间间隔, 如interval 5 year
- 流程函数
	- if (value, t, f), 如果value真,返回t, 否则f
	- ifnull(v1, v2), 如果不空, 返回v1
	- case when  v1 then r1, else default end ...
	- case expr when v1 then r1 else..
## 约束
作用与字段, 在创建和修改时指定约束
有: 
- 非空 not null
- 唯一 unique
- 主键 primary key : 非空且唯一
- 默认约束 default 指定默认值
- 检查约束 check 保证满足某个条件 
- 外键约束 foreign key 用于链接两张图,保证数据一致性和完整性
	- [[外键约束]]
- 自增 auto_increment

例子:
```sql
create table user(  
	id int primary key auto_increment,  
	name varchar(10) not null unique,  
	age int check(age > 0 and age < 120),  
	status char(1) default '1',  
	gender char(1)  
);
```
## 多表查询
有三种情况, 一对多, 多对多, 多对一
### 查询 结合韦恩图
```sql
# 合并查询(笛卡尔积, 展示所有组合结果) 没有连接
select * from table1, table2;

# 内连接查询,查两张表的交集
## 注意显式写INNER性能更好
## 根据条件去创建一张表
select 字段列表 from 表1 [INNER] JOIN 表2 ON 条件;


# 外连接, 查询左/右/双表所有数据和交集部分数据
## 和内连接的区别是是否保留没有匹配上的记录, 外连接保留,并在没有数据的字段显示 null
## 字段列表可以来自两张表,如果同名需要加tablename.来区分
## 一般来说必须有on的那个字段
select 字段列表 from 表1 LEFT/RIGHT/Full [OUTER] JOIN 表2 on 条件;

# 自连接, 必须用别名, 当作两张表操作
select 字段列表 from 表名 别名 JOIN 表名 别名 on xxx

# 联合查询, 合并成一个结果集, 可以继续合并
# 加all就不去重了
# 加all效率更高
# 联合查询比用or查询效率更高, 可以利用索引
SELECT column1, column2,... FROM table1 UNION [ALL] SELECT column1, column2,... FROM table2 UNION [ALL] SELECT column1, column2,... FROM table3 ... UNION [ALL] SELECT column1, column2,... FROM tablen;

# 子查询
# 在select中嵌套select
select * from t1 where c1 = (select c1 from t2);
# 子查询外面可以是任何操作 [[子查询]]
# 子查询结果可能是标量(单个值), 列, 行, 表
值 一般用来 数值判断
列 一般用来 in , 多个数值
行 一般用来 in 
表 一般用来 in
注意, 判断可以用(,,) = (,,)
```
## 事务
事务是一组操作的集合, 会把所有操作当作整体提交, 要么同时失败,要么同时成功.
### 如何在sql中使用事务:
```java
# 事务提交方式: 
 - 1 自动提交
 - 0 手动提交, 只对当前会话有效
set @@AUTOCOMMIT = 0;

#开始定义一个trasaction
start transaction;
# 两个账户操作
update account set money = 1111 where ..;
update account set money = 2222 where ..;


# 提交事务 , 结束事务
COMMIT;


# 回滚事务 , 结束事务
ROLLBACK;
```
rollback在sql中一般是存储过程或者判断时用, 如使用row_count判断最近一次执行的语句影响了多少条数据, 如果没有影响(也就是修改失败), 就可以回滚.