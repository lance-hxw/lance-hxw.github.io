## 架构
mysql分成两层, server和存储引擎
![[Pasted image 20241204211029.png]]
### Server层: 连接, 分析, 执行逻辑
- 连接器: 与client通信, 基于TCP
- 缓存处理: 命中, 更新
- 解析器: 没命中就处理sql成语法树, 交给执行器
- 执行器: 预处理+优化器+执行器, 接受语法树, 返回记录并写缓存
	- 执行器调用存储引擎的api
### 存储引擎: 负责数据存取
- 提供api给server层调用.
- 有InnoDB, MyISAM, Memory等, 最常用的是InnoDB
	- innoDB索引类型是B+
## 工作流程
### 连接
- 基于tcp, 用户权限根据登录时决定, 中途修改需要重行连接才能有正确权限配置
- 如果不执行命令会被判定为sleep空闲连接, 空闲连接超过指定时长就会被断开. 也可以手动断开. 但是不会给client发msg, 而是等他请求时才发现断开了.
- 超过最大连接数就无法进行新连接了
- 有长短连接, 长连接更方便, 但是内存占用大
	- 需要处理长连接的这个问题
		- 可以定期断开长连接
		- 让client主动重置连接
### 查缓存
如果是select就查缓存, 直接用sql语句为key去查, 所以命中率非常低...所以mysql8.0直接被删掉了, 此前的版本也可以用query_cache_type设demand
- 但是引擎中的缓存还是需要的
### 解析sql
词法分析-语法分析, 变成语法树
### 执行sql
#### 预处理器
检查表和字段, 将\*扩展成具体字段
#### 优化器
决定怎么执行
#TODO 索引
#### 执行器
调用存储引擎的api, 以记录为单位,
三种执行方式:
- 主键索引
- 全表扫描
- 索引下推
#TODO 
## Inno引擎 数据存放

一个数据库对应一个database的目录
一个database的目录下, 实际有:
- db.opt
	- 默认字符集和字符校验规则
- tableName.frm
	- 表结构
	- 每个表对应一个frm文件, 保存元数据, 即结构定义等
- tableName.ibd
	- 表数据, 如果innodb_file_per_table是1, 就是表单独存在ibd文件
		- 如果不是1, 就存在共享表空间(ibdata1)
		- 这个ibd文件叫独占表空间文件

