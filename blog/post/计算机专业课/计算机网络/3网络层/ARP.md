# 地址解析协议ARP

已知IP地址，需要其MAC地址，这就需要ARP协议。

原本有RARP，但DHCP已经包含此功能，就废弃了。

## 场景

- 在链路上传递IP数据报，需要封装为MAC帧，使用MAC地址
- MAC地址在格式上和IP地址不同，无法简单映射
- 更换网卡，增减主机会导致映射需要能变更

## ARP的解决方法

- 在主机的ARP高速缓存中，存放一个从IP地址到MAC地址的映射表，并且时常动态更新
- 每台主机都有一个ARP cache，存有，当前局域网上所有，已知的，IP到MAC地址的映射

### 获取映射关系

当主机A向本局域网上主机B发送IP数据报时（路由器转发给B也一样）：
- 先在ARP cache中查询是否有B的mac地址，如果有，直接取出，写入mac帧。
- 如果没有，这可能是B刚刚入网，也可能是A刚刚开机没有缓存。此时A运行ARP，寻找B的mac地址。

ARP获取新映射的流程为：

- ARP进程在本局域网上广播一个ARP请求分组：“我的IP是--，mac地址是--，我想知道IP地址是---的主机的mac地址”。
- 局域网上所有主机运行的ARP进程都收到
- B发现其IP地址一致，收下此分组，向A发ARP响应分组，包含IP地址和Mac地址，这是一个单播。
- A接受到响应分组，在cache中写入映射。

当B收下这个请求分组时，意味着AB可能要经常通信，于是他把A的映射也写入自己cache。

### 生存时间

cache中的每个项目都有一个生存时间，超时后会被删除。这是为了防止如下场景：

B的网卡坏了，换了mac地址，但是A无法知晓这一变化。

如果定时删除映射，A就能重新获取映射。

## 注意

- ARP只涉及同一局域网中的映射，跨域局域网时，需要路由器转发，只要路由器同时有两边的映射即可。
- ARP隐式运行，自动完成查询替换，不需要用户主动操作。

## ARP使用场景：

- 主机A与主机B在同一局域网，进行传播
- 主机A与主机B在不同局域网，主机A只要找到路由器的mac地址，传播给他
- 路由器在另一端网络站查找B，发送。
- 路由器需要再找一个路由器中继

## 为什么要用mac和IP两个地址

各个局域网形势不同，使用不同的mac地址，结构各异，使用IP地址可以让网络层不需要进行复杂的地址转换和查询，使用统一规范转发，而将IP地址到mac的转换交由计算机自主完成。

在获取ip地址之前还需要区分设备，必须得有mac