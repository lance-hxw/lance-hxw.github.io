# 网际控制报文协议ICMP

为了有效转发IP数据报和提高交付成功的机会。

ICMP运行主机报告差错情况或异常，他装在IP数据报中，但不是高层协议。

## 分类与格式

 - 差错报告报文 
 - 询问报文

前4B是统一格式

- 类型
- 代码
- 检验和 ： 检验整个ICMP报文，因为IP数据报首部校验不含数据部分

然后4B 和类型有关

- 差错：3-终点不可达，11-超时，12-参数问题 ，5-改变路由
- 询问：8/0-回送请求/回送回答，13/14-时间戳请求时间戳回答

然后是数据字段 长度和类型有关

差错类型：

- 终点不可达： 无法交付，就向源点发终点不可达
- 时间超过： 路由器收到TTl=0的数据报，就向源点发超时；如果终点不能及时收到所有分片，也发超时。
- 参数问题：数据报首部字段值不正确，发参数问题。
- 改变路由/重定向： 路由器告知主机，下次应该将报文送给其他路由，即找到了更优路由。（主机刚开始使用时，把所有报文都转给一个默认路由器，需要学习最佳路由）

不会发送ICMP差错报文的情况：

- 对ICMP报文不发送. 
- 对第一个分片后所有片
- 多播地址的数据报
- 特殊地址的数据报

询问报文：

- 回送请求，回送回答：主机向目标主机发送询问，收到询问报文需要发送ICMP回答报文，用于测试可达等信息。
- 时间戳请求和回答：这样的一次问答可以得到往返时延


# PING
执行ping的时候，首先dns获取ip，然后向目标ip发送ICMP Echo Request
目标受到，就响应ICMP Echo Reply
ping方收到就计算并显示发送到接受的RTT时长和丢包情况（会发很多个）
# traceroute
发送带有TTL的icmpEcho请求，每经过一个路由器（网关）TTL就减1。
这样，先发TTL=1的包，然后发TTL=2的，就可以探测网络拓扑结构。
直到抵达目标路径，就恢复icmp echo，表示完成路径

与基于udp的方法区别（windows用icmp，linux/unix会默认用udp进行traceroute）
- icmp跟容易通过防火墙（相比随机端口udp）

linux上可以用-I指定发送icmp探测，但是需要root权限