# TCP

## 特点

- 面向连接
- 点对点
- 全双工的
- 可靠交付
- 面向字节流，“流”，虽然程序交互是数据块，但是TCP把这些数据仅仅当作字节流处理，无结构。和UDP一次交付一个报文不同，TCP对缓冲区数据量 和网络拥塞程度，判断填充多少字节，也会等待字节积攒足够再发送。


## 连接 

TCP连接的端点是套接字端口，即IP+端口=socket

一个TCP连接，就是两个socket

## 可靠传输的工作原理

理想通信：

- 信道无差错
- 及时通信

但信道总是不可靠，不过可以用协议缓解

### 停止等待协议

每发完一个分组就等待确认，然后再发送下一个分组

这是一个ARQ，自动重传请求

#### 无差错

发送-确认-发送-确认-发送-确认。。。

#### 出现差错

B接受报文，发现差错，丢弃，或者未接收，则B不会发送确认消息，因为根本不知道有个报文。故A无法获取确定消息，于是进行超时重传。

- A在发一个分组后，要存一个副本用于重传，确认后才删去
- 分组和确认分组需要编号，才能明确那个分组被确认
- 超时计时器的重传时间应该比数据在分组传输的平均往返时间略长，长则效率低，短则不必要重传。

#### 确认丢失，确认迟到

B的确认报文丢失了，或者迟到了，那么A会进行重传，此时B：

- 丢弃重复分组
- 再次确认，让A发下一个

#### 信道利用率

停止等待协议简单，但利用率低下。

额外开销是RTT和B确认耗时。

必须开销是A发送分组的时间

### 连续ARQ

滑动窗口

每收到一个确认，窗口就滑动一位，如果接受到第5位的确认，那么前几位就确认了。

但是有回退问题

## TCP报文首部格式

20B

#### 源端口，2B

#### 目的端口 ，2B

#### 序号 ，4B

增加到最大后，下一个是0。

序号用于明确数据顺序，每个字节都要编号。

建立连接时，设置起始序号。

#### 确认号， 4B

期望收到对方下一个报文段的第一个数据字节的序号。

B在填写确认报文时使用。

当确认报文中确认号为N，则之前所有字节都已经收到。

#### 数据偏移 ，4B

数据的开始处相对于TCP报文起始的位置，因为有可选首部。

这个偏移的单位是4B，故最大60B，即TCP首部最大长度。

#### 保留 6bit

全0

#### 6个控制位

- URG ：1有效，紧急传送，不管顺序，如中断。
- ACK : 1有效，确认，TCP连接建立后，ACK即为1
- PSH ：发送方将PSH置1，发送请求，另一端立即将缓存区取出发送。
- RST ：TCP连接严重差错，需要释放连接，重建
- SYN : 同步，用于建立时同步序号，SYN=1，而ACK=0，就是一个连接请求报文段，如果对方同意，就在响应报文段中让SYN和ACK均为1.
- FIN ：终止，1表明数据传输结束。

#### 窗口，2B

告知对方自身的缓存区，即允许现在发送的数据量，一直变化

#### 检验和 2B

检验首部和数据，加上伪首部

#### 紧急指针 2B

URG=1时生效，指出紧急数据的字节数，紧急数据后是普通数据。

窗口为0也可发送紧急数据

#### 选项 最长40B，让整个首部长60B

如MSS，最大报文段长度，是TCP报文长度减去首部。

时间戳 4B，用于计算时延

