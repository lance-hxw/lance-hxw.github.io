# 不用ssl/tls时http的问题
- 身份伪装：
	- 伪装服务端
	- 伪装客户端
- 明文通讯，直接窃取数据
- 报文可能被篡改，无法校验
## 中间人攻击：伪装server和client，获取全部信息
# 两种加密方式
## 对称加密的特点
- 密钥简单，加解密速度快
缺点有：
- 必须双方提前约定加密规则
- 每个client都需要不同密钥，所以需要管理大量密钥
- 不安全环境下无法建立通讯
## 非对称加密的特点
非对称加密的算法复杂度很高，不适合长期使用

公钥加密，私钥解密，是用于client到server的加密通讯
私钥加密，公钥解密，是**签名算法**，只用于校验证书
- 签名可以验证发送的对象（持有私钥），同时还可以进行完整性校验

优点是：
- 私钥不传递，非常安全
- 可拓展，公钥可以公布，不需要约定密钥

# 流程(单向验证)
部署前：服务器安装证书
- client hello ：client生成随机数R1， 发出请求，并告知自己支持的加密算法
- Server hello ：server生成随机数R2，选择一种加密算法作为会话密钥生成算法
	- 然后响应，发送证书，R2，和加密算法
- client获得证书后
	- 取出公钥，解密数字签名，校验身份问题，向CA校验证书合法性
	- 取出会话密钥生成算法，随机数R2
	- 用R1，R2，R3生成会话密钥，将R3用公钥加密发送给server
- server使用私钥解密，得到R3，使用R1，R2和R3，以及自己指定的算法，得到密钥
## 三个"随机数"
- R1: client 随机数
- R2: server随机数
- R3: 预主密钥
## 主密钥
server和client基于同样的算法，使用三个数生成主密钥
## 会话密钥：由主密钥派生
用于client到server和server到client的加密/校验
- 加密密钥和mac密钥
这还允许会话中更新密钥，而不用更新主密钥

## 双向验证 mTLS
- 就是客户端也有证书
# https加密了什么：建立连接后，http的头部和正文都会被加密
但是url会暴露在各种历史记录中，所以url不安全
不过即使在握手的时候，url在数据包中也是加密的
- 因为先tcp连接上，再tls连接上，然后才发送http数据包，此时完全加密了
# 如何向CA验证
## 发证书：
ca将包括持有者公钥在内的所有信息打包，计算一个hash
使用ca私钥将这个hash值加密，得到证书签名，将这个签名放在证书上。
## 校验：
解密成功后，还检查有效期，然后利用ca的撤销列表或者在线状态协议验证状态
还要验证域名

## 证书链校验
客户端获取证书的时候，会获取所有证书，即证书链，包括server证书和所有中间证书
根证书一般不用，是有个信任列表的。