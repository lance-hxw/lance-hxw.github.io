https相比http多一个tls握手, 最长需要2个RTT, 并且还有对称加密通讯的开销
- 对称加密部分, 现在用AES等, 开销是非常小的
所以主要就是tls握手的过程
- 网络延迟, 最长2RTT
- 密钥协商算法耗时
- CA验证耗时
- 派生密钥耗时

## 硬件优化

cpu支持AES-NI的会在对称加密时更快
cpu更强也能加快非对称加密阶段的性能

## 软件优化

os的优化等, 但是这个优化除非有针对性, 否则不明显且风险大, 成本高

## 协议优化

这里主要优化的是密钥交换的过程

在对称加密部分, 使用AES128这种短的可以牺牲一点安全换速度

### 使用ECDHE

- ECDHE支持第四次握手前就开始发送加密数据, 此时最长时延变成1RTT了
	- 因为第三次握手刚发出不用等他到, 就可以发消息了
- 使用高性能椭圆曲线如x25519
	- 在nginx等地方, 可以提前配置优先使用的曲线

### TLS升级

直接用tls1.3, 性能更好
- 完成整个握手需要1RTT
- 安全性更好
[[https 非对称加密 和对称加密#TLS1.3]]

## 证书优化

### 证书传输
减小证书大小, 使用ECDHE的证书会比RSA的更短
### 证书验证
使用OCSP stapling
[[https 非对称加密 和对称加密#OCSP stapling]]

## 会话复用

显然, 最耗时的就是密钥协商过程
如果能复用这个密钥, 性能就变好了

这个部分还涉及到连接的重连
### session ID
双方用这个id标记去kv缓存这个会话密钥
- 这个会提升服务端内存占用
- 导致server有状态, 在集群中不一定有效

### session Ticket
将缓存交给客户端, 类似http层面的cookie
将会话密钥加密后传给client

client再次连接时, 将ticket传过去, server校验, 相当于一个token, 不过里面携带的是加密的会话密钥

此时:
- server无状态, 只要保证加密密钥相同, 就可以在各个地方使用这个ticket
- server内存压力低
### pre-shared key

前两个方法都要1rtt恢复连接

tls1.3中支持pre-shared key, 可以用0RTT重建连接

- 后续连接/重连时, 将ticket和http一起发过去, 成就成, 不成就拉倒

不过三个方法都有前向安全问题, 一旦服务器被攻破, 就没有安全性