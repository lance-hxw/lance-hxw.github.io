
# 分布式一致性保证：如何解决多副本延迟和故障导致的数据同步问题
在多副本系统中，必定存在写的不一致（请求到达先后）
所以大部分的多副本数据系统都是提供最终一致性保证
- 即写完后， 等待足够长时间后，读的结果一致
- 即，所有不一致都是暂时的
最终一致性也可以叫作收敛性

但是最终一致性非常不好，因为不知道什么时候才收敛，所以完全无法和单线程应用一样进行开发。
在最终一致性保证下，开发全程需要注意系统限制，同时由于其在低负载下往往不会有问题，也更容易在线上出问题。

但是，强一致性也意味着低性能
这是一个权衡
实践中，往往用分层的策略，即：
- 底层解决可用性，性能和容量问题
- 上层解决一致性问题
或者提供多种一致性模型让用户取舍

# 线性一致性
线性一致性就是:
- 让系统就像只有一个数据副本一样
- 系统上的所有操作都可以原子完成
- 是最强一致性
- 或者叫:原子一致性, **强一致性**, 即时一致性,外部一致性
- 满足线性一致性的系统, 无论实际有多少副本, 应用层都可以不关心且轻松使用其功能.
- 保证数据最新，"最近"，是一种新鲜度保证

为什么说线性，如果两个请求并发，其中一个返回旧值还可以接受，如果后来请求返回了更旧的值，就完全不线性了，这是不能接受的

## 如何实现线性一致性

就是如何让他像单副本一样？

### 读写并发

每个请求都有开始和结束
读请求的取数据在这个区间的任一时刻
写请求的写入也在其区间的任一时刻

所以只要区间有交集，就是并发读写

### 问题的边界

在单副本系统中，显然应该保证：
- 没有写请求时，读都是最新数据
- 并发读写过程中可能新可能旧
同时还应该注意到， 在单副本系统中：
- 并发读写时，就算数据不是最新的，也不能交替不确定
- 可以理解为，任何时间都只有一个状态

这是很难的，由于时钟问题，分布式系统中“先后”的概念是不可靠的，这就导致了线性关系也不可靠

既然我们需要保证
“写操作中，必须有这样一个时间点，在这个时间点前系统读取结果是旧，这个时间点后，系统读取结果是新的”
- 这个性质我们可以称为“可见性”


# 什么情况需要线性一致性

- 锁
- 选举算法
- 唯一性约束
- 多渠道时序依赖: 如果只有一个信息渠道, 用户是感知不到不一致的
	- 如果用户能接触到多个信息渠道, 才会意识到不一致
	- 比如各种异步操作, 就容易触发一致性问题
	- 或者并发请求
	- 如果你能在一起管理所有信息渠道, 就可以在应用层使用(读自己写)的解决方法
		- 解决读写一致性[[3 写入问题(滞后)#读自己写]]

# 如何实现线性一致性

核心两个直觉是:
- 分布式系统表现的就像一个数据副本
- 任何操作都是原子性完成

可以尝试的方案:
- 单副本: 最简单, 也不好用
- 多副本:
	- 单主: 可能是线性一致的
		- 需要线性一致性的读在主上读, 写在主上写, 就可以实现读写一致性
		- 但是单主模型面临选主问题, 如果系统本身出现不一致, 读写也是不一致的
	- 共识算法: 虽然是单主, 但是用共识算法避免选主故障, 可以实现线性一致性
		- 如zk, etcd
	- 多主模型: 多个节点写入, 由于是异步的, 几乎不可能线性一致, 甚至会出现需要手动解决的冲突, 这显然不像"一个副本"
	- 无主模型, Dynamo-style, 虽然说是可以按quorum读写实现线性一致性(隐藏内部细节, 当做一个副本处理), 但是由于时钟偏差, 还有放松的quorum策略, 都会破坏线性一致性[[Dynamo-style]]
		- 原因比如, 如果w=n, 写了全部节点, 但是还没来及写完, 此时两个r=1的读取, 可能一个读到新数据, 一个读到旧数据, 就不一致了
		- 所以这实际只能实现最终一致性
		- Dynamo一般认为是AP的
		- 如何解决: 需要牺牲一些性能
			- 每个读之前进行同步(阻塞)的读修复, cassandra会这样
			- 发任何写请求前, 读最新值(防止写入冲突和写入失败), cassandra是lww
		- 总结: 可以认为dynamo不提供线性一致性

综上, 其实只有 单副本, 和基于共识协议的系统能提供线性一致性

# 线性一致性的代价

对于单主模型, 
- 如果不强制读主副本, 那么就没有一致性保证
- 如果强制读主副本, 如果主副本连不上(client连接了一个从副本, 然后路由去主副本), 这类读写都会失败

多主模型倒是不会失败, 不过根本不一致

# CAP

cap中的c一般就当做线性一致性, 也就是说, 在P不能消除的情况下, 如果不提供线性一致性就可以高可用, 反之亦然

cap是一个引子 他只是揭示了分布式系统设计中权衡的一角, 如今更多当做历史名词
需要考虑的一致性不是只有线性一致性, 同样的, 问题也不只是网络分区P

cap是一个时代的产物, 在这个历史时期, 分布式系统在share-nothing方向上进行了各种探索, 同时推进了数据库设计从强一致性到弱一致性(NoSQL)的转变

# 为什么都没有线性一致性

抛开cap的理论, 往往抛弃线性一致性不是为了"网络分区下的HA", 而是性能等因素, 比如cpu利用了缓存, 就会导致一致性问题

实践中, 往往牺牲线性一致性就能实现一个更快的系统, 然后去对不一致性处理, 保证结果的正确性(如提供最终一致性), 这样往往是更好更可用系统


