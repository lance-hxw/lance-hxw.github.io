在基于拜占庭容错（BFT）的分布式共识协议（如 Tendermint、HotStuff 等）中，整个决策过程通常分为三个阶段：

1. **提议（Propose）**
    
2. **预投票（Pre-vote）**
    
3. **预提交（Pre-commit）**
    

其中，**预投票（Pre-vote）** 阶段扮演着**安全过滤**和**信息同步**的关键角色。

---

## 一、Pre-vote 的定义

- 在收到区块（或命令）提议后，每个验证节点都会在本地验证该提议的合法性（比如：格式正确、交易合法、签名有效、与本地已锁定的区块无冲突等）。
    
- 若验证通过，节点就向网络中**广播“预投票”消息**，表示自己“倾向”接受该提议；否则，节点广播“空票”或“不支持”消息。
    

---

## 二、Pre-vote 的主要作用

1. **防止冲突决议**
    
    - 节点只有在看到“充分多数”（通常为超过 2/3 节点）对同一提议的预投票后，才会进一步进入预提交阶段，防止不同节点因网络延迟或恶意提议而对不同区块作出相互冲突的决策。
        
2. **信息传递与状态同步**
    
    - 通过收集各节点的预投票消息，节点可以得知网络中哪些区块被大多数节点认可，保证节点间在进入下一个阶段时达成一致视图（view）。
        
3. **安全锁定（Locking）**
    
    - 如果节点在某一轮次对某个区块进行预提交（Pre-commit），它也必须在未来轮次中尊重对此区块的“安全锁定”：不再对其他提议投票，除非解锁条件满足（如看到新一轮的更高高度的预投票多数）。
        

---

## 三、Pre-vote 的流程示例（以 Tendermint 为例）

1. **Propose 阶段**
    
    - 轮值验证者（proposer）向所有节点广播待签名的区块。
        
2. **Pre-vote 阶段**
    
    - 每个节点本地验证该区块：
        
        - 若合法且与之前的锁定状态不冲突，则广播 `PREVOTE` 消息。
            
        - 否则，广播 `PREVOTE nil`（空票）。
            
3. **收集 Pre-vote**
    
    - 节点等待收集到来自 > 2/3 验证节点的 `PREVOTE` 消息：
        
        - 若对同一区块收集到 > 2/3 `PREVOTE`，进入 Pre-commit 阶段。
            
        - 若对不同区块或空票没有形成多数，则可能进入下一高度或下一轮次。
            
4. **Pre-commit 阶段**
    
    - 基于 Pre-vote 结果，节点决定是否广播 `PRECOMMIT`。
        
    - 只有当 > 2/3 节点发出对同一区块的 `PRECOMMIT` 时，区块才被提交（Commit）并上链。
        

---

## 四、关键要点与注意事项

- **超时与轮次切换**：若在预投票阶段未能在规定时间内收集到足够多数（> 2/3），节点会触发超时，跳到下一个轮次（new round），并重新从提议阶段开始。
    
- **锁定（Lock）规则**：一旦节点对某区块在 Pre-commit 阶段投出支持票，它便被“锁定”在该区块上，后续轮次只有在看到更高轮次对其他区块的预投票多数时，才会“解锁”并改投。此机制保证网络中不会出现两条平行链。
    
- **消息认证**：所有的 `PREVOTE` 和 `PRECOMMIT` 消息都需要签名，以防止恶意节点伪造或重放旧消息。
    
- **性能与延迟**：增加预投票阶段虽然提高了安全性，但也带来额外的消息往返延迟。因此，实际实现中会对延时敏感的场景做优化，比如合并消息（gossip）或使用快速路径。
    

---

### 小结

预投票（Pre-vote）阶段是 BFT 共识协议中不可或缺的一环，通过分阶段、多轮次的投票与锁定机制，确保在面临恶意节点或网络分区时，系统仍能保持**安全性**（Safety）和**活跃性**（Liveness）两大属性的平衡。